var log = require("log");
log.setLevel("INFO");


var documents = require("document");


var params = {};

if(request.body != null){
	params = request.body;
}else if(request.parameters.body){
	params = request.parameters.body;
} else {
  params = request.parameters;
}
if(typeof params == 'string' && params != null){
  	try{
    	params = JSON.parse(params);   
    }catch(e){
      	return "INVALID OR MISSING PARAMETER";
    }
}

var number = params.number;

var startDate = params.startDate;
var endDate = params.endDate;

if(startDate == null || typeof startDate == 'undefined'){
  startDate =  new Date();
  startDate.setHours(0);
  startDate.setMinutes(0);
  startDate.setSeconds(0);
  startDate = formatDate(startDate)
}

if(endDate == null || typeof endDate == 'undefined'){
  endDate = formatDate(new Date())
}

var results;

var queryParams = {};
var fieldsParams = "*";
var queryString = 'formType = "order"';

queryParams["count"] = "true";
queryParams["query"] =  queryString;
if(params.startDate != null && typeof params.startDate != 'undefined'){
        queryParams["query"] += 'and orderDate<date> >= "' + startDate + '" and orderDate<date> <= "' + endDate + '"';
    }
queryParams["fields"] =  fieldsParams;
results = documents.query(queryParams);
var docs =  results.result.documents;

var imgSrc = {
    
    "userImg" : "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEYAAABGCAYAAABxLuKEAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkU0Q0EyRjBDODFFNzExRTRCM0FDOEEzQUQ2RDY2NTVGIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkU0Q0EyRjBEODFFNzExRTRCM0FDOEEzQUQ2RDY2NTVGIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RTRDQTJGMEE4MUU3MTFFNEIzQUM4QTNBRDZENjY1NUYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RTRDQTJGMEI4MUU3MTFFNEIzQUM4QTNBRDZENjY1NUYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6A+sjfAAAGf0lEQVR42uxcDWxTVRS+7/XHAZOOugWW6czc5uqSGYMGgxlOjFMIc3HGHxJYQmKCEcGpyZRA1JiAP5MQgxMkqAgTImIE/yLGMEQgGKMGtqgb7oc1wmB/sVk3ZtvXes7b2/LY+tr32nNf27kv+dKu67v3vO+dc+49975XIbSPmY0iYAEwD1ii+vx2oBfYqvztAzYrf7cBL5hppNWEPmYAy4FVwGXArCjfL9P4vBN4AHgEeJy30QInj8lSRKhSRJlB3H4v8BvgIUUoX7ILg2GyHlgNtJjk9QPArcB6oIeqUZGonVzgXmALcJWJoiCcwE3ALuCrwPRkEMaueMjvipckEg7gy4otVYkUphjYBHyd6ioReu/nCh1mC4Ph8ouSU5IVVcqFW2iGMJg7tgN3cxhpeHnPD8qF5CYMCnEQ+BRLLdiVC1nLQxgU5VuKpJZA1CkkEwbD55MIM9JUQq0yipKUBO8DK6ktDDpuZYHcFSyYebf8ftIV8zQxse9HZnXvk98TAkdRN3B/PDPfGuDblFZJmYtYwLVRftWd8ftOMGvLZvmVCFhCoAE/xyLMAuAJJXnRWFPyJgvkr4294m2vZ/bmF6nMwaL0DqWk0C1MujIHyKOwIGRzsH9Lj4QNGcPDKITVNSeXMMFPUhZhEfqwkeRbRyUKgkqUsdyE7RFOAiv1CnMbcDVl+FCJohYH2yXC9nAlTThh3qGqjuWRJ46cEgnYrpEEHgE54YbwicLgolIplfH+kjrGE4H8p6maqlGWLzSFWU/VU2jmjVRXVHvoz35Q7ocAGEprtYTB4fleSqPNAGE/NerCWC3ME7QTuVJzhKHrx6muBUVVkfgIqcW2DHOqH9p+qicKs2xi8vmfAgefeWphlkxrMr6SUK4Wpnxak6u8RhYGp/651K0LnrOmnAWHfsrGhFnAxSf7Tprj+/T9oJPkoDDFPAzGRSaiCljbW6B97IcDClCYIl5GW9vf5SoMts9J/CIUpoCf4fXcvGZU+HpepsvCOHm6uv23J7m0je1yDFWHyDhvr1q6vyIXB9vDdjmCvzBySLk/JhMH28H2OCMdhbEzE4AnI6/VDnfFFpZwHB5vgiiyo6MwHmYScPsj7dhCeaVfr0D4Pfw+Hke4fRINXtwl6OIx89UDXPrE9ZSgo+TqKtn/DxM9zXIeId5s04sG3IkcSJQw8m5jYk48GjwYSpem68ZJuIDCtE3rMAmdGEp/mJFLcDeStEbiG4JnUJhfqVvFhCplV8i7BESr+JojFo5Ulu6vKSd8mHPbcFTCVatBRnDrWCB3JfO7NnAVI5JItpbXKOY5eGN1BeYYCdgYb6iMLD7NfPN3JkQUBPaL/aMdcW4Jfy+PmCqVYvYSyk17inyG9qBdMaJRLcxniucYFkX2EsLESuI9YA/aFYM4Z9joEy/jwvQa9Rq8Mrz3puMF2mfQkxvGJ5/hPtSDZPQULc/Re0pMdV+eWphDeid7ftfGpMkpujwb7NWB/eoqQC0M5pg3dOUWutsvTIEOeyeduxgmxtzREm6yh1C4kIqSiPHJudZIwmCcvRDRNTnf88ItpLTt9oY7Z1FDPc0RSkpRYSLYvZmFeRBV667NZ4FXtGaYqQgNu7GA3hruH1rC4Oi0ZoovLeCFf5RpPGga6SGLj4zObVIM6yItuUR7+mQNj2WJJMAO4AeRvhBNGMzYS9nUWuX7UvEWFo8wY3XUUjY11oaxcl6up2DW+4Qbesxdqew54sBPPfBSoTXaxioMAh9jWSQOnruSaqJYeo91WHoab9ArilFhEJcs3V/kWXqPn0+N6a6PWf7+9Dspa3G+37XB0O8/GH7u2n9z7WUpqyzP6m7Yw6TkdR5hpDtg7dy1Wrr+sZjuSI35Sf1AbvUqW8d79yWd90hDIcvFw6esXQ03QVW9K9Zm4vr9GH/hc0fhJc/atu3xYGbpjmDG/DmJm/NLzNJz9E/Rc3Y5eHWTFGdzJL8GEih45gCI4rR27HwpEclZ7D910dZeXynNvb8YRSEJRaO/HzP80FB0Nzz/4Zbgta4VQeed85jA5xdThMBgSOw/3SJ4W98K5K/breeYmYdnJVaYMdjObXGF0rJfCc7Kuyc0u3huyJYhxJtQxcEWtzDUcVAYubwJRhqvkeOTRphJntS2bSWzX/dAyOa4JWR35jD7nNkhwSqG0gvT1EOsONQ+PCpETw/z9buFgPcvwde311/4fFw39RoR5j8BBgAWxB+p4VEEogAAAABJRU5ErkJggg=="
    
}

var locations = {};
for(var i = 0; i < docs.length; i++){
    locations[docs[i].key] = {};
    locations[docs[i].key]["0"] = [];
    locations[docs[i].key]["0"][0] = {
        "lat" : {"value": docs[i].location.split(",")[0]},
        "long" :  {"value": docs[i].location.split(",")[1]},
        "number" :  {"value": docs[i].number},
        "orderStatus" :  {"value": docs[i].orderStatus},
        "name" :  {"value": docs[i].name},
        "img" : {"value" : imgSrc.userImg},
        "address" :  {"value": docs[i].address},
        "orderDate" :  {"value": docs[i].orderDate},
        "client" :  {"value": docs[i].client},
        "assignee" :  {"value":(docs[i].assignee) ? docs[i].assignee : "Unassigned"},
        "bounce" :  {"value": (docs[i].orderStatus != 'Confirmed') ? true : false},
        
    }
    locations[docs[i].key]["order"] = "0";
    locations[docs[i].key]["source"] = "simulator";
}

function atLeastTwoDigits (value) {
	return value < 10 ? "0" + value : value;
}

function formatDate(date){
  var formattedDate = date.getFullYear()
                    + "-" + atLeastTwoDigits(date.getMonth() + 1)
                    + "-" + atLeastTwoDigits(date.getDate())
                    + "T" + atLeastTwoDigits(date.getHours())
                    + ":" + atLeastTwoDigits(date.getMinutes())
                    + ":" + atLeastTwoDigits(date.getSeconds());
  formattedDate += date.getTimezoneOffset() < 0 ? "+" : "-";
  formattedDate += atLeastTwoDigits((Math.abs(date.getTimezoneOffset()) / 60)) + "00";
  return formattedDate
}
var message = {"result": locations, "id" : "everyone-main-live"};
publish("responseChannel", message);
return  locations








