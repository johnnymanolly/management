var log = require("log");
log.setLevel("INFO");
var documents = require("document");

var params = {};
if(request.body != null){
    params = request.body;
}else if(request.parameters.body){
    params = request.parameters.body;
} else {
    params = request.parameters;
}
if(typeof params == 'string' && params != null){
    try{
        params = JSON.parse(params);   
    }catch(e){
        return "INVALID OR MISSING PARAMETER";
    }
}

var results;
var action = params.action;
var key = params.key;

if(action){
    if(action == "add"){

    }else if(action == "edit"){
        var queryParams = {};
        queryParams["query"] =  'key = "'+ key +'"';
        queryParams["fields"] = "*";
        var orderQueryResults = documents.query(queryParams);
        if(orderQueryResults.metadata.status == "failure") {
            return {status : "failure", errorDetails : "an error has occured when quering order document: " + key, errorMsg: orderQueryResults};
        } 

        var updateParams = JSON.parse(JSON.stringify(params));
        updateParams["formType"] = "reservation";
        updateParams["meta.types"] = {
            "orderDate" : "date"
        }
        var fieldsToSave = updateParams;
        var fieldsToSaveResult = documents.save(fieldsToSave);
        if(fieldsToSaveResult.metadata.status == "failure") {
            return fieldsToSaveResult.metadata;
        }else{
            fieldsToSave["key"] = fieldsToSave.key;
            var message = {"result": "success", "id" : "reservation-grid"};
            publish("responseChannel", message);

            if(params.orderStatus && params.orderStatus == "Confirmed"){
                var number = orderQueryResults.result.documents[0]["number"];
                var user = apsdb.callApi("GetUser", {login: number}, null);
                if(user.metadata.status == "success" && user.result.user.gcmRegId){
                    var gcmRegId = user.result.user.gcmRegId;
                    var message = '{"Content": "Your order has been confirmed"}';  
                    var arrayDevices = [gcmRegId];
                    var deviceType = "android";
                    push(arrayDevices, message, deviceType);
                }
            }

            return   {result : "success"}
        }
    }else if(action == "delete"){

    }
}else{
    var queryParams = {};
    var fieldsParams = "*";
    var queryString = 'formType = "reservation"';

    queryParams["count"] = "true";
    queryParams["query"] =  queryString;
    queryParams["fields"] =  fieldsParams;

    log.info(JSON.stringify(queryParams))
    results = documents.query(queryParams);

    return results.result

}

